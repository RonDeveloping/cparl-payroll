generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ===== USER SERVICE (Authentication)  =====
// ==========================================

model User {
  id           String   @id @default(cuid())
  slug         String   @unique
  givenName    String   @map("given_name")
  familyName   String   @map("family_name")
  email  String   @unique @map("email")
  emailVerifiedAt       DateTime? @map("email_verified_at")
  pendingEmail  String?   @map("pending_email")
  phone  String   @unique @map("phone")
  phoneVerifiedAt       DateTime? @map("phone_verified_at")
  pendingPhone  String?   @map("pending_phone")
  passwordHash String?  @map("password_hash")
  contactId    String   @unique @map("contact_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("user")
}

// ==========================================
// ===== CONTACT SERVICE (Identity)     =====
// ==========================================

model Contact {
  id          String   @id @default(cuid())
  givenName   String   @map("given_name")
  familyName  String   @map("family_name")
  middleName  String?  @map("middle_name")
  suffix      String?
  prefix      String?
  nickName    String?  @map("nick_name")
  displayName String?  @map("display_name")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  legalNameHistory          LegalNameHistory[]
  conversationalNameHistory ConversationalNameHistory[]
  addresses                 Address[]
  emails                    Email[]
  phones                    Phone[]

  @@map("contact")
}

model LegalNameHistory {
  id            String    @id @default(cuid())
  contactId     String    @map("contact_id")
  givenName     String    @map("given_name")
  familyName    String    @map("family_name")
  middleName    String?   @map("middle_name")
  effectiveFrom DateTime  @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  changedBy     String?   @map("changed_by")
  reason        String?
  createdAt     DateTime  @default(now()) @map("created_at")

  contact Contact @relation(fields: [contactId], references: [id])

  @@index([contactId, effectiveFrom])
  @@map("legal_name_history")
}

model ConversationalNameHistory {
  id            String                    @id @default(cuid())
  contactId     String                    @map("contact_id")
  suffix        String?
  prefix        String?
  nickName      String?                   @map("nick_name")
  displayName   String?                   @map("display_name")
  source        conversational_name_source?
  effectiveFrom DateTime                  @map("effective_from")
  effectiveTo   DateTime?                 @map("effective_to")
  createdAt     DateTime                  @default(now()) @map("created_at")

  contact Contact @relation(fields: [contactId], references: [id])

  @@index([contactId, effectiveFrom])
  @@map("conversational_name_history")
}

model Address {
  id          String  @id @default(cuid())
  contactId   String  @map("contact_id")
  street      String
  city        String
  province    String
  postalCode  String  @map("postal_code")
  country     String
  addressHash String  @map("address_hash")
  isPrimary   Boolean @default(false) @map("is_primary")

  contact Contact @relation(fields: [contactId], references: [id])

  @@unique([contactId, addressHash])
  @@index([contactId])
  @@map("address")
}

model Email {
  id           String   @id @default(cuid())
  contactId    String   @map("contact_id")
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  emailAddress String   @map("email_address")

  contact Contact @relation(fields: [contactId], references: [id])

  @@unique([contactId, emailAddress])
  @@index([contactId])
  @@map("email")
}

model Phone {
  id        String      @id @default(cuid())
  contactId String      @map("contact_id")
  number    String
  type      phone_type? @default(mobile)
  isPrimary Boolean     @default(false) @map("is_primary")

  contact Contact @relation(fields: [contactId], references: [id])

  @@unique([contactId, number])
  @@index([contactId])
  @@map("phone")
}

// ==========================================
// ===== PAYROLL SERVICE (Logic)        =====
// ==========================================

model Employee {
  id             String          @id @default(cuid())
  tenantId       String          @map("tenant_id")
  contactId      String          @map("contact_id")
  employeeNumber String?         @map("employee_number")
  taxIdEncrypted Bytes           @map("tax_id_encrypted")
  taxIdLast4     String          @map("tax_id_last_4")
  dateOfBirth    DateTime        @map("date_of_birth")
  hireDate       DateTime        @map("hire_date")
  status         employee_status
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  addressCached Json   @map("address_cached")
  emailCached   String? @map("email_cached")
  phoneCached   Json?  @map("phone_cached")
  nameCached    Json   @map("name_cached")

  employments  Employment[]
  payrollRuns  PayrollRunEmployee[]
  bankAccounts BankAccount[]

  @@unique([tenantId, contactId])
  @@unique([tenantId, employeeNumber])
  @@map("employee")
}

model Employment {
  id           String    @id @default(cuid())
  tenantId     String    @map("tenant_id")
  employeeId   String    @map("employee_id")
  title        String?
  department   String?
  startDate    DateTime  @map("start_date")
  endDate      DateTime? @map("end_date")
  countryCode  String    @default("CA") @map("country_code")
  provinceCode String    @map("province_code")
  createdAt    DateTime  @default(now()) @map("created_at")

  employee       Employee        @relation(fields: [employeeId], references: [id])
  jobAssignments JobAssignment[]

  @@index([tenantId, employeeId, startDate])
  @@index([employeeId, startDate])
  @@map("employment")
}

model JobAssignment {
  id           String    @id @default(cuid())
  employmentId String    @map("employment_id")
  startDate    DateTime  @map("start_date")
  endDate      DateTime? @map("end_date")
  payRate      Decimal   @db.Decimal(10, 2) @map("pay_rate")
  payType      pay_type  @map("pay_type")

  employment   Employment    @relation(fields: [employmentId], references: [id])
  timeEntries  TimeEntry[]
  payrollLines PayrollLine[]

  @@index([employmentId, startDate])
  @@map("job_assignment")
}

model TimeEntry {
  id              String   @id @default(cuid())
  jobAssignmentId String   @map("job_assignment_id")
  workDate        DateTime @map("work_date")
  hours           Decimal  @db.Decimal(6, 2)

  jobAssignment JobAssignment @relation(fields: [jobAssignmentId], references: [id])

  @@index([jobAssignmentId, workDate])
  @@map("time_entry")
}

model PayrollRun {
  id          String             @id @default(cuid())
  tenantId    String             @map("tenant_id")
  periodStart DateTime           @map("period_start")
  periodEnd   DateTime           @map("period_end")
  runDate     DateTime           @map("run_date")
  status      payroll_run_status
  createdAt   DateTime           @default(now()) @map("created_at")

  payrollRunEmployees PayrollRunEmployee[]

  @@unique([tenantId, periodStart, periodEnd])
  @@map("payroll_run")
}

model PayrollRunEmployee {
  id              String   @id @default(cuid())
  payrollRunId    String   @map("payroll_run_id")
  employeeId      String   @map("employee_id")
  nameSnapshot    String   @map("name_snapshot")
  addressSnapshot String   @map("address_snapshot")
  grossPay        Decimal  @db.Decimal(10, 2) @map("gross_pay")
  deductions      Decimal  @db.Decimal(10, 2)
  netPay          Decimal  @db.Decimal(10, 2) @map("net_pay")
  createdAt       DateTime @default(now()) @map("created_at")

  payrollRun    PayrollRun            @relation(fields: [payrollRunId], references: [id])
  employee      Employee              @relation(fields: [employeeId], references: [id])
  payrollLines  PayrollLine[]
  deductionsList Deduction[]
  disbursements PayrollDisbursement[]

  @@unique([payrollRunId, employeeId])
  @@map("payroll_run_employee")
}

model PayrollLine {
  id                   String       @id @default(cuid())
  payrollRunEmployeeId String       @map("payroll_run_employee_id")
  jobAssignmentId      String?      @map("job_assignment_id")
  rate                 Decimal      @db.Decimal(10, 2)
  units                Decimal      @db.Decimal(6, 2)
  amount               Decimal      @db.Decimal(10, 2)
  earningType          earning_type @map("earning_type")

  payrollRunEmployee PayrollRunEmployee @relation(fields: [payrollRunEmployeeId], references: [id])
  jobAssignment      JobAssignment?     @relation(fields: [jobAssignmentId], references: [id])

  @@map("payroll_line")
}

model Deduction {
  id                   String         @id @default(cuid())
  payrollRunEmployeeId String         @map("payroll_run_employee_id")
  type                 deduction_type
  amount               Decimal        @db.Decimal(10, 2)
  createdAt            DateTime       @default(now()) @map("created_at")

  payrollRunEmployee PayrollRunEmployee @relation(fields: [payrollRunEmployeeId], references: [id])

  @@unique([payrollRunEmployeeId, type])
  @@map("deduction")
}

model BankAccount {
  id                String            @id @default(cuid())
  employeeId        String            @map("employee_id")
  institutionNumber Int               @map("institution_number")
  branchNumber      Int               @map("branch_number")
  accountNumber     String            @map("account_number")
  currency          String            @default("CAD")
  isPrimary         Boolean           @default(false) @map("is_primary")
  type              distribution_type @default(remainder)
  value             Decimal?          @db.Decimal(10, 2)
  isActive          Boolean           @default(true) @map("is_active")

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("bank_account")
}

model PayrollDisbursement {
  id                   String              @id @default(cuid())
  payrollRunEmployeeId String              @map("payroll_run_employee_id")
  institutionNumber    Int                 @map("institution_number")
  branchNumber         Int                 @map("branch_number")
  accountNumber        String              @map("account_number")
  amount               Decimal             @db.Decimal(10, 2)
  status               disbursement_status @default(pending)
  processedAt          DateTime?           @map("processed_at")

  payrollRunEmployee PayrollRunEmployee @relation(fields: [payrollRunEmployeeId], references: [id])

  @@index([payrollRunEmployeeId])
  @@map("payroll_disbursement")
}

// ==========================================
// ===== TENANT SERVICE (Settings)      =====
// ==========================================

model Tenant {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  legalName      String   @map("legal_name")
  businessNumber String?  @map("business_number")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  settings      TenantSettings?
  payrollCycles PayrollCycle[]
  departments   Department[]

  @@map("tenant")
}

model TenantSettings {
  id       String @id @default(cuid())
  tenantId String @unique @map("tenant_id")
  timezone String @default("America/Toronto")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  
  @@map("tenant_settings")
}

model PayrollCycle {
  id        String        @id @default(cuid())
  tenantId  String        @map("tenant_id")
  name      String
  frequency pay_frequency

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("payroll_cycle")
}

model Department {
  id       String  @id @default(cuid())
  tenantId String  @map("tenant_id")
  name     String
  code     String?

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@map("department")
}

model ChartOfAccount {
  id        String           @id @default(cuid())
  tenantId  String           @map("tenant_id")
  code      String
  name      String
  type      account_type
  category  account_category
  isActive  Boolean          @default(true) @map("is_active")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  glMappings GLMapping[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("chart_of_account")
}

model GLMapping {
  id                String        @id @default(cuid())
  tenantId          String        @map("tenant_id")
  chartOfAccountId  String        @map("chart_of_account_id")
  mappingType       mapping_type  @map("mapping_type")
  earningType       earning_type? @map("earning_type")
  deductionType     deduction_type? @map("deduction_type")
  departmentId      String?       @map("department_id")

  chartOfAccount    ChartOfAccount @relation(fields: [chartOfAccountId], references: [id])

  @@index([tenantId, mappingType])
  @@map("gl_mapping")
}

// ==========================================
// ===== ENUMS (Lowercase for Postgres) =====
// ==========================================

enum conversational_name_source {
  user
  support
  import
  system
}

enum phone_type {
  mobile
  home
  work
}

enum employee_status {
  active
  terminated
  on_leave
}

enum pay_type {
  hourly
  salary
}

enum earning_type {
  regular
  overtime
  bonus
  commission
  other
}

enum payroll_run_status {
  draft
  finalized
  paid
}

enum deduction_type {
  tax
  cpp
  ei
  benefit
  other
}

enum distribution_type {
  fixed_amount
  percentage
  remainder
}

enum disbursement_status {
  pending
  sent
  failed
  reconciled
}

enum pay_frequency {
  weekly
  biweekly
  semimonthly
  monthly
}

enum account_type {
  asset
  liability
  equity
  revenue
  expense
}

enum account_category {
  cash
  payroll_expense
  tax_payable
  benefit_payable
  wages_payable
  other
}

enum mapping_type {
  earning
  deduction
  employer_tax
  net_pay_clearing
}